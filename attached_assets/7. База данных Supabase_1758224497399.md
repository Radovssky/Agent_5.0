-- 1. ТАБЛИЦА ПОЛЬЗОВАТЕЛЕЙ И ИХ СЕССИЙ (объединяем users + user_sessions)
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telegram_user_id BIGINT NOT NULL,
    telegram_chat_id BIGINT NOT NULL,
    username VARCHAR(50),
    first_name VARCHAR(100),
    
    -- Сессия
    topic TEXT NOT NULL,
    status VARCHAR(20) DEFAULT 'active', -- active, completed, cancelled
    current_step VARCHAR(50) DEFAULT 'topic_input',
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. ТАБЛИЦА НАЙДЕННЫХ ВИДЕО (как Sources + Reels в Notion-примере)
CREATE TABLE found_videos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID REFERENCES user_sessions(id) ON DELETE CASCADE,
    
    -- Основная информация
    video_id VARCHAR(100) NOT NULL,
    platform VARCHAR(20) NOT NULL,
    title TEXT,
    description TEXT,
    url TEXT NOT NULL,
    thumbnail_url TEXT,
    
    -- Метрики
    views BIGINT DEFAULT 0,
    likes BIGINT DEFAULT 0,
    comments BIGINT DEFAULT 0,
    duration INTEGER,
    published_at TIMESTAMP WITH TIME ZONE,
    
    -- Контент
    transcript TEXT,
    transcript_ru TEXT,
    keywords TEXT[],
    
    -- Простая аналитика (как в Notion-примере)
    engagement_score DECIMAL(5,2), -- автоматически рассчитывается
    is_viral BOOLEAN DEFAULT FALSE, -- Hot/не Hot
    
    -- Статус использования
    status VARCHAR(20) DEFAULT 'found', -- found, analyzed, used
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. ТАБЛИЦА СЦЕНАРИЕВ И ВИДЕО (объединяем scripts + videos)
CREATE TABLE generated_content (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID REFERENCES user_sessions(id) ON DELETE CASCADE,
    
    -- Сценарий
    script_text TEXT,
    script_status VARCHAR(20) DEFAULT 'draft', -- draft, approved, rejected
    script_version INTEGER DEFAULT 1,
    improvement_notes TEXT, -- что просил изменить пользователь
    
    -- Видео (HeyGen)
    heygen_video_id VARCHAR(100),
    video_url TEXT,
    video_status VARCHAR(20) DEFAULT 'not_started', -- not_started, generating, completed, failed
    
    -- Настройки для видео
    avatar_id VARCHAR(100),
    voice_id VARCHAR(100),
    background_id VARCHAR(100),
    
    -- Публикация
    publication_status VARCHAR(20) DEFAULT 'not_published', -- not_published, publishing, published, failed
    published_links JSONB DEFAULT '{}'::jsonb,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. ТАБЛИЦА ЛОГОВ (только критичные события)
CREATE TABLE activity_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID REFERENCES user_sessions(id) ON DELETE SET NULL,
    telegram_user_id BIGINT,
    
    action VARCHAR(100) NOT NULL, -- search_started, videos_found, script_generated, video_created, published
    message TEXT,
    data JSONB DEFAULT '{}'::jsonb, -- дополнительные данные
    status VARCHAR(20) DEFAULT 'success', -- success, error, warning
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ИНДЕКСЫ (минимально необходимые)
CREATE INDEX idx_sessions_telegram_user ON user_sessions(telegram_user_id);
CREATE INDEX idx_sessions_status ON user_sessions(status);
CREATE INDEX idx_found_videos_session ON found_videos(session_id);
CREATE INDEX idx_found_videos_viral ON found_videos(is_viral, engagement_score DESC);
CREATE INDEX idx_content_session ON generated_content(session_id);
CREATE INDEX idx_logs_session ON activity_logs(session_id);
CREATE INDEX idx_logs_action ON activity_logs(action);

-- ФУНКЦИЯ ДЛЯ РАСЧЕТА ENGAGEMENT (упрощенная)
CREATE OR REPLACE FUNCTION calculate_simple_engagement()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.views > 0 THEN
        NEW.engagement_score := ((NEW.likes + NEW.comments * 2.0) / NEW.views::DECIMAL) * 100;
        NEW.is_viral := NEW.engagement_score > 15.0;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_video_engagement
    BEFORE INSERT OR UPDATE ON found_videos
    FOR EACH ROW EXECUTE FUNCTION calculate_simple_engagement();

-- ФУНКЦИЯ ДЛЯ АВТООБНОВЛЕНИЯ updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_sessions_updated_at 
    BEFORE UPDATE ON user_sessions 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
    
CREATE TRIGGER update_content_updated_at 
    BEFORE UPDATE ON generated_content 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();