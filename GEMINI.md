# GEMINI.md - Обзор проекта "Video Content Agent"

## 1. Обзор проекта

Этот проект представляет собой каркас (скелет) для создания интеллектуального агента на **TypeScript**, предназначенного для автоматизации производства видеоконтента. Изначальная идея, описанная в `Описание проекта.md` и `logika.md`, была интерпретирована и преобразована в масштабируемую архитектуру, использующую современные инструменты для разработки.

Агент НЕ является проектом n8n. Это полноценное Node.js-приложение.

**Ключевые технологии:**

*   **Язык:** TypeScript
*   **Среда выполнения:** Node.js (>=20.9.0)
*   **Оркестратор задач:** [Inngest](https://www.inngest.com/) - управляет последовательностью выполнения задач (поиск, анализ, генерация), заменяя собой логику n8n.
*   **Основной фреймворк:** Mastra - набор инструментов и библиотек для создания AI-агентов.
*   **База данных:** PostgreSQL (через библиотеку `pg`). Инструменты для работы с БД уже написаны.
*   **AI Модель:** Настроен для работы с OpenAI (`gpt-4o`), но фактическая генерация сценариев пока является заглушкой.
*   **Интерфейс:** Telegram Bot (триггер и инструменты для отправки сообщений реализованы).

**Архитектура:**

Проект имеет четкую структуру:

*   `src/triggers`: Точка входа. Принимает вебхуки от Telegram.
*   `src/mastra/workflows`: Определяет высокоуровневую логику. `telegramContentWorkflow.ts` получает сообщение, передает его агенту и отправляет ответ.
*   `src/mastra/agents`: "Мозг" системы. `videoContentAgent.ts` содержит инструкции и набор инструментов для выполнения задач.
*   `src/mastra/tools`: Набор инструментов для конкретных операций (поиск видео, работа с БД, анализ контента).
*   `src/mastra/storage`: Настройка подключения к базе данных.

---

## 2. Состояние готовности

Проект является **функциональным каркасом**, но **не готовым продуктом**.

*   **Что реализовано (Готово к работе):**
    *   **Веб-сервер и триггер:** Система может принимать HTTP-запросы (вебхуки) от Telegram.
    *   **Оркестратор Inngest:** Рабочий процесс (`workflow`) корректно настроен для передачи данных между шагами.
    *   **Инструменты для работы с БД:** Все функции в `databaseTools.ts` содержат реальный SQL-код для работы с сессиями, видео и сценариями.
    *   **Инструменты для Telegram:** Функции в `telegramTools.ts` полностью готовы для отправки сообщений пользователю.
    *   **Логика анализа метрик:** Инструмент `videoMetricsAnalysisTool` содержит реальную логику для расчета вовлеченности.

*   **Что является заглушкой (Требует реализации):**
    *   **Поиск видео (`videoSearchTools.ts`):** Функции **не выполняют реальный поиск** в YouTube, TikTok и Instagram. Они возвращают заранее заготовленные, случайные данные.
    *   **Транскрипция видео (`contentAnalysisTools.ts`):** Функция `videoTranscriptionTool` **не вызывает сервис транскрипции**. Она возвращает случайный текст из заранее определенного списка.
    *   **Генерация сценария (`scriptGenerationTools.ts`):** Функции **не обращаются к AI-модели (GPT-4o)**. Они генерируют сценарий на основе простых текстовых шаблонов.
    *   **Интеграция с HeyGen и Blotato:** Эти части отсутствуют.

---

## 3. Сборка и запуск

**Шаг 1: Настройка окружения**

1.  **Установите зависимости:**
    ```bash
    npm install
    ```

2.  **Создайте файл `.env`** в корневой папке проекта. Этот файл будет содержать все ваши секретные ключи. Заполните его по следующему шаблону:

    ```env
    # Ключи для базы данных PostgreSQL
    DATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DATABASE"

    # Ключи для Telegram
    TELEGRAM_BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"

    # Ключи для AI-модели (OpenAI или аналог)
    OPENAI_API_KEY="YOUR_OPENAI_API_KEY"
    # OPENAI_BASE_URL=... (если используете прокси или другой сервис)

    # TODO: Добавить ключи для API поиска видео (YouTube, TikTok)
    # YOUTUBE_API_KEY="YOUR_YOUTUBE_API_KEY"

    # TODO: Добавить ключи для сервиса транскрипции (например, OpenAI Whisper)

    # TODO: Добавить ключи для HeyGen и Blotato
    # HEYGEN_API_KEY="YOUR_HEYGEN_API_KEY"
    # BLOTATO_API_KEY="YOUR_BLOTATO_API_KEY"
    ```

**Шаг 2: Запуск в режиме разработки**

1.  **Запустите dev-сервер Mastra/Inngest:**
    ```bash
    npm run dev
    ```
    Эта команда запустит локальный сервер (обычно на `http://localhost:3000`) и веб-интерфейс Inngest для отслеживания задач (обычно на `http://localhost:8288`).

2.  **Сделайте ваш сервер доступным для Telegram:**
    Используйте `ngrok` или аналогичный сервис, чтобы создать публичный URL, который будет перенаправлять запросы на ваш локальный сервер.
    ```bash
    ngrok http 3000
    ```

3.  **Настройте вебхук Telegram:**
    Установите URL вебхука для вашего бота, используя URL от ngrok. Замените `<YOUR_BOT_TOKEN>` и `<YOUR_NGROK_URL>`.
    ```
    https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook?url=<YOUR_NGROK_URL>/webhooks/telegram/action
    ```

Теперь бот готов к работе. Сообщения, отправленные боту, будут запускать рабочий процесс, но он будет использовать заглушки для поиска и генерации.

---

## 4. План доработки

Чтобы довести проект до полнофункционального состояния, необходимо заменить заглушки реальной логикой:

1.  **Создать схему БД:** На основе кода в `databaseTools.ts` создать в вашей базе данных PostgreSQL таблицы: `user_sessions`, `found_videos`, `generated_content`, `activity_logs`.
2.  **Реализовать поиск видео:** В файле `src/mastra/tools/videoSearchTools.ts` заменить заглушки на реальные вызовы API YouTube, TikTok и др.
3.  **Реализовать транскрипцию:** В `src/mastra/tools/contentAnalysisTools.ts` в инструменте `videoTranscriptionTool` добавить вызов API сервиса транскрипции (например, OpenAI Whisper).
4.  **Реализовать генерацию сценария:** В `src/mastra/tools/scriptGenerationTools.ts` заменить шаблонную логику на вызов AI-модели (GPT-4o) с промптом, включающим данные анализа.
5.  **Добавить генерацию видео и публикацию:** Создать новые файлы инструментов (`videoGenerationTools.ts`, `publishingTools.ts`) и реализовать в них интеграцию с HeyGen и Blotato.
6.  **Обновить агента:** Добавить новые инструменты в `videoContentAgent.ts`, чтобы он мог их использовать.
